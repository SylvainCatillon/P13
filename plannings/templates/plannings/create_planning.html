{% extends 'core/base.html' %}
{% block content %}
{% load widget_tweaks %}

<div class="container">
<div id="intro" class="mb-2 p-1">
<button id="intro_collapse_button" class="btn btn-sm float-right" type="button"
        data-toggle="collapse" data-target="#intro_text" aria-expanded="false"
        aria-controls="collapseExample" aria-label="Switch intro">
  <i class="far fa-eye-slash"></i>
  </button>
  <div id="intro_text" class="collapse show">
    <h3 class="text-center">Bienvenue sur la création du planning!</h3>
    <p>Après avoir donné un nom à votre planning, vous pouvez y ajouter des
      évènements, ou créer votre planning sans évènements.</p>
    <p>Vous pouvez choisir de restreindre l'accès au planning aux personnes
      dont vous aurez indiqué l'e-mail, ou de laisser le planning accessible à
      toute personne possédant le lien.
      Dans tout les cas, le lien du planning vous sera affiché une fois la
      création terminée.</p>
    <p>Une fois votre planning créé, vous pourrez à tout moment le modifier</p>
  </div>
</div>

<form id="planning_form" method="post" action="{{ form_url }}">
  {% csrf_token %}
  {{ event_formset.management_form }}
  <div class="form-group">
    <label class="sr-only">{{ planning_form.name.label_tag }}</label>
    {% render_field planning_form.name class+="form-control" placeholder=planning_form.name.label %}
  </div>

  <br>

  {% with form=event_formset.empty_form %}
    <div id="add_event_container dropdown">
    {% include 'plannings/event_form.html' with button_text='Ajouter un événement' hide_delete=True %}
    </div>
    <div id="model_event_card" style="display: none">
      {% include 'plannings/event_card.html' with display_form=false %}
    </div>
  {% endwith %}

  <div id="created_events_container"
       class="bg-dark row my-3 p-1 rounded overflow-auto
       row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5"
       style="height: 200px"
  >
    {% for form in event_formset.forms %}
    {% include 'plannings/event_card.html' with display_form=True button_text='Modifier' %}
    {% endfor %}
  </div>

  <br>

  <div class="form-group form-check">
    {% include 'core/form_field.html' with field=planning_form.protected %}
  </div>

  {% for hidden in planning_form.hidden_fields %}
    {{ hidden }}
  {% endfor %}

  {% for email in planning_form.instance.guest_emails.all %}
    <input type="hidden" value="{{ email }}" name="guest_email">
  {% endfor %}
</form>
<div class="alert alert-success" id="success_alert" style="display: none"> {# TODO: use modal instead? #}
  <button type="button" class="close" data-dismiss="alert">x</button>
  <strong>Succès! </strong> Les informations sont valides.
</div>

  <div id="edit_guests_container"
       class="mb-3 p-2 border border-dark rounded dropdown"
       style="display: none">

    <form id="add_guest_form">
      <div class="input-group">
        <input class="form-control" id="add_guest_input" type="email"
               name="add_guest" placeholder="invité@exemple.com" required>
        <div class="input-group-append">
          <button id="add_guest_submit" class="btn btn-secondary">
            <label for="add_guest_input" style="display: inline">
              Ajouter cet email
            </label>
          </button>
        </div>
      </div>
    </form>

    <div id="guests_display"
         class="bg-light my-3 rounded overflow-auto text-center"
         style="height: 100px">
      {% for email in planning_form.instance.guest_emails.all %}
        <p id="id_{{ email }}">{{ email }}</p>
      {% endfor %}
    </div>


    <div class="dropup">
      <button id="delete_guest_dropdown"
              class="btn btn-danger mt-2 dropdown-toggle"
              data-toggle="dropdown" aria-expanded="false">
        Supprimer des emails
      </button>
      <div id="guests_select_form" class="form-group text-center dropdown-menu"
           aria-labelledby="delete_guest_dropdown">
        <a class="close"
           onclick="$('#delete_guest_dropdown').dropdown('hide')">
          <span aria-hidden="true">&times;</span></a>
        <div class="form-group">
          <label for="guest_emails_select">Emails sélectionnés</label>
          <select id="guest_emails_select" class="form-control mb-2"
                  name="emails_to_delete" multiple>
            {% for email in planning_form.instance.guest_emails.all %}
              <option value="{{ email }}">{{ email }}</option>
            {% endfor %}
          </select>
          <button id="delete_guest_submit" class="btn btn-danger">
            <span>Supprimer ces emails</span>
          </button>
        </div>
      </div>
    </div>
  </div>

<br>

<input id="planning_submit" class="btn btn-primary btn-lg btn-block mb-4"
       form="planning_form" type="submit"
       value="{% if 'edit' in request.path %}Enregistrer les modifications{% else %}Créer le planning{% endif %}">

</div>
{% endblock %}
{% block js %}
  {{ block.super }}
  <script type="text/javascript">
  $(function () {

      // Change the eye icon on intro toggle
      $("#intro_text").on("hide.bs.collapse", function () {
          $("#intro_collapse_button").html('<i class="far fa-eye"></i>')
      }).on("show.bs.collapse", function () {
          $("#intro_collapse_button").html('<i class="far fa-eye-slash"></i>')
      })

      // Set the boundary as viewport for all the dropdowns
      $(".dropdown-toggle").dropdown({boundary: 'viewport'})


      // Avoid dropdown close on click inside
      $(".dropdown-menu").on("click", function (event) {
          event.stopPropagation()

      })

      function setEventCard($card) {
          let $form = $card.find('.event_form')
          $card.find(".card-header, .card-text").each(function (i, elem) {
              let $elem = $(elem),
                  $input = $form.find('[name$="'+$elem.data("field")+'"]')
              $elem.text($input.val())

          })
          if ($form.find('[name$="DELETE"]').prop("checked")) {
              $card.addClass("event_card--deleted")
          } else {
              $card.removeClass("event_card--deleted")
          }
      }

      // Set the data of the existing events
      $("#created_events_container .event_card").each(function () {
          setEventCard($(this))
      })

      // Show the 'edit guests' container if the 'protected' input
      // is already checked on page load
      if ($('#id_protected').prop("checked")){
          $("#edit_guests_container").show()
      }

      // Show the options to choose guests only if input 'protected' is checked
      $("#id_protected").on("change", function () {
        let $guests_container = $("#edit_guests_container")
        if (this.checked) {
            $guests_container.show()
        } else {
            $guests_container.hide()
        }
      });

      /*
      When the 'add guest form' is submitted:
      -check that the guest's email isn't already added
      -add the email in the guests display
      -add an option with the email as value to the guest's email select
      -add a hidden input with the guest's email as value
      -reset the input
       */
      $("#add_guest_form").on("submit", function (event) {
          event.preventDefault()
          let $input = $('input[name="add_guest"]'),
              email = $input.val(),
              $guests_select = $("#guest_emails_select"),
              $guests_container = $('#guests_display')

          if ($guests_select.text().includes(email)) {
              alert("Vous avez déjà indiqué cette adresse")
          } else {
            $guests_container.append($("<p></p>", {id: "id_"+email, text: email}))
            $guests_select.append($("<option></option>", {value: email, text: email}))
            $('#planning_form').append($("<input>", {value: email, type: "hidden", name: 'guest_email'}))
            $guests_container.scrollTop(
              $guests_container[0].scrollHeight)
            $input.val("")
          }
      });


      /*
      For each selected guest email option:
      -Remove the select option
      -Remove the associate hidden input
      -Remove the email from the guests display
       */
      $("#delete_guest_submit").on("click", function (event) {
          event.preventDefault()
          let data = $('#guest_emails_select').serializeArray()
          $.each(data, function (i, field) {
            $('option[value="'+field.value+'"]').remove()
            $('input[name="guest_email"][value="'+field.value+'"]').remove()
            $('p[id="id_'+field.value+'"]').remove()
          })
      });

      /*
      Function launched after a successful server validation
      on an existing event modification
       */
      function validExistingEvent($card) {
          setEventCard($card)
          $card.find('.dropdown-toggle').dropdown('hide')
          let $created_events_container = $('#created_events_container')
          $card.parent().appendTo($created_events_container)
          $created_events_container.scrollTop(
              $created_events_container[0].scrollHeight)

          $("#success_alert").fadeTo(2000, 500).slideUp(500, function() {
              $("#success_alert").slideUp(500);
          });

      }

      /*
      Function launched after a successful server validation
      on an new event
       */
      function validNewEvent($form, data) {
          let $formContainer = $form.parent(),
              $new_event = $('#model_event_card').find('.event_card_container').clone(),
              $card = $new_event.find('.card'),
              formset_prefix = $form.data('prefix').replace(/__prefix__/g, ""),
              $total_forms_input = $('input[name="'+formset_prefix+'TOTAL_FORMS"]'),
              form_number = $total_forms_input.val(),
              $created_events_container = $("#created_events_container")

          $card.append($formContainer.html().replace(/__prefix__/g, form_number))

          // Set the new event dropdown button
          let $dropdownButton = $card.find('.dropdown-toggle')
          $dropdownButton.text('Modifier')
          $dropdownButton.dropdown({boundary: 'viewport'})

          // Set the data of the new event form and card
          $.each(data, function () {
              let $input = $card.find('[name$="'+this.name+'"]')
              if ($input.length && $input.attr('type') !== "hidden") {
                  $input.val(this.value)
              }

          })
          setEventCard($card)
          // Show the delete input and label
          $card.find('[name$="DELETE"]').parent().show()

          //Set the onClick function of validate event button
          $card.find('.validate_event').on('click', function (event) {
              event.preventDefault()
              validateEvent($(this).parents(".event_form"))

          })

          //Reset the 'add event' form
          $formContainer.find('input, textarea').each(function () {
              let $this = $(this),
                  type = $this.attr('type')
              if ($this.val() && type !== "hidden") {
                  if (type === 'checkbox') {
                      $this.prop('checked', false)
                  } else {
                      $this.val("")
                  }
              }

          })

          // Increase the value of the TOTAL_FORMS input
          $total_forms_input.val(parseInt(form_number) + 1)

          $created_events_container.append($new_event)
          $created_events_container.scrollTop(
              $created_events_container[0].scrollHeight)
          $('.dropdown-toggle').dropdown('hide')

      }

      function validateEvent($eventForm) {
          let data = $('input[name="csrfmiddlewaretoken"]').serializeArray(),
              prefix = $eventForm.data("prefix")+"-";

          // Remove the previous errors of the form
          $eventForm.find(".field_errors li").each(function (i, error) {
              error.remove()
          });

          // Gather the form's data, and remove the formset prefix, because
          // the 'check event' function use the original form, not the formset
          $eventForm.find('input, textarea').each(function () {
              if ($(this).val()) {
                  let value = $(this).serializeArray()[0]
                  if (value) {
                    value.name = value.name.replace(prefix,"")
                    data.push(value)
                  }
              }
          })

          // Post the data to the 'check event' function
          $.post($eventForm.data("check-url"), data).done(function () {
              if (prefix.includes('__prefix__')) {
                  validNewEvent($eventForm, data)
              } else {
                  validExistingEvent($eventForm.parents('.card'))
              }

          }).fail(function (jqXHR) {
              if (jqXHR.status === 422) {
                  let data = JSON.parse(jqXHR.responseText)
                  $.each(data, function (field) {
                      let $errorsContainer = $("#id_" + prefix + field + "_errors"),
                          $input = $("#id_" + prefix + field)
                      $input.val(function () {
                          return this.defaultValue

                      })
                      $.each(data[field], function (i, error) {
                          $errorsContainer.append($('<li>' + error.message + '</li>'))

                      })
                  })
          } else {
              alert("Une erreur s'est produite, veuillez réessayer. Erreur HTTP "+jqXHR.status)
          }

          });
      }

      $('.validate_event').on('click', function (event) {
          event.preventDefault()
          validateEvent($(this).parents(".event_form"))

      })
  })
  </script>
{%  endblock %}