{%  extends 'core/base.html' %}
{%  block content %}
<div class="container table-responsive"><h3 class="text-center">{{ planning.name }}</h3>
{#  <form method="post" action="{% url 'participations:participate' %}">#}
  {% csrf_token %}
  <table class="table table-bordered text-center">
  <thead class="thead-light">
  <tr>
    <th class="text-muted">Événements</th>
    <th class="text-muted">Dispos</th>
    <th scope="col">{{ user.first_name }}</th>
    {% for participant in other_participants %}
      <th scope="col" class="d-none d-md-table-cell">{{ participant.first_name }}</th>
    {%  endfor %}
  </tr>
  </thead>
  <tbody>
  {%  for event in  events%}
    <tr>
      <td class="bg-dark"> {# events column #}
        <div class="dropright my-1">
          <a id="event_{{ event.id }}" class="dropdown-toggle btn text-white" data-toggle="dropdown" aria-expanded="false">
          {{ event.date|date:"d M" }}
          </a>
          <div class="dropdown-menu" aria-labelledby="event_{{ event.id }}">
            <p>{% if event.time %}{{ event.time }}{% endif %}</p>
            <p>{{ event.address }}</p>
            <p>{{ event.description }}</p>
          </div>
        </div>
      </td>
      <td> {# availabilities column #}
        <div class="dropright">
          <button id="summary_{{ event.id }}" class="dropdown-toggle btn" data-toggle="dropdown" aria-expanded="false">
            <span>{{ event.participations_summary.YES|length }} oui</span>
          </button>
          <div class="dropdown-menu" aria-labelledby="summary_{{ event.id }}">
            <ul class="list-group list-group-flush">
              <li class="list-group-item list-group-item-success">
                <h5 >Oui</h5>
                {{ event.participations_summary.YES|join:", " }}{#  <span class="badge badge-primary badge-pill">{{ event.participations_summary.YES|length }}</span>  #}
              </li>
              <li class="list-group-item list-group-item-warning">
                <h5 >Peut-être</h5>
                {{ event.participations_summary.MAYBE|join:", " }}{#  <span class="badge badge-primary badge-pill">{{ event.participations_summary.MAYBE|length }}</span>  #}
              </li>
              <li class="list-group-item list-group-item-danger">
                <h5 >Non</h5>
                {{ event.participations_summary.NO|join:", " }}{# <span class="badge badge-primary badge-pill">{{ event.participations_summary.NO|length }}</span>  #}
              </li>
            </ul>
          </div>
        </div>
      </td>
      <td class="align-middle"> {# user column #}
{#        {%  with participation=event.user_participation %}#}
{#      <select id="select_event_{{ event.pk }}" name="answer">#}
{#            <option value="">---------</option>#}
{#        {% for answer, display in event.user_participation.answer_choices %}#}
{#          <option value="{{ answer }}" {% if answer == participation.answer %} selected {% endif %}>{{ display }}</option>#}
{#        {% endfor %}#}
{#        {% endwith %}#}
{#      </select>#}
{#      <input type="hidden" name="event" value="{{ event.pk }}">#}

{#        {{ event.user_participation_form.answer}}#}
{#        {{ event.user_participation_form.event}}#}

        <div class="dropright my-1">
          {%  with participation=event.user_participation %}

  {#          <select>#}
  {#            <option value="">---------</option>#}
  {#            <option value="YES">Oui</option>#}
  {#            <option value="NO">Non</option>#}
  {#            <option value="MAYBE">Peut-être</option>#}
  {#          </select>#}
          <button id="DropAnswerEvent{{ event.pk }}" class="dropdown-toggle btn btn-{{ participation.get_color|default:"info" }}" js-initial-data="{{ participation.answer|default:"New" }}" data-toggle="dropdown" aria-expanded="false">
              <span>{{ participation.answer|default:"New" }}</span>
          </button>
          <form class="dropdown-menu answer_form" js-event-pk="{{ event.pk }}" aria-labelledby="DropAnswerEvent{{ event.pk }}" action="{% url 'participations:participate' %}"> {# TODO: action ou tag js-data pour transmettre l'url au script #}
{#            {% csrf_token %} {# TODO: placer qu'une seule fois #}
            {% for answer, display in event.user_participation.answer_choices %}
            <input type="radio" name="answer" value="{{ answer }}" js-displayed-answer="{{ display }}" id="AnswerChoice{{ forloop.counter }}Event{{ event.pk }}" {% if answer == participation.answer %} checked="checked" {% endif %}>
            <label for="AnswerChoice{{ forloop.counter }}Event{{ event.pk }}">{{ display }}</label><br>
            {% endfor %}
            <input type="hidden" name="event" value="{{ event.pk }}">
          </form>
        </div>
        {%  endwith %}
      </td>
        {% for participation in event.other_participations %} {# participants column #}
          <td class="d-none d-md-table-cell align-middle table-{{ participation.get_color|default:"info" }}">
            <span>{{ participation.get_answer_display }}</span>
          </td>
        {% endfor %}

{#      {% for participation in event.participation_set.all %}#}
{#        {% if participation.participant != user %}#}
{#        <td>#}
{#          <p>{{ participation }}</p>#}
{#        </td>#}
{#        {%  endif %}#}
{#      {% endfor %}#}

    </tr>
  {% endfor %}
  </tbody>
  </table>
<button id="submit_answers" class="btn btn-info">Envoyer</button>
<button id="reset_answers" class="btn btn-info">Reset</button>
{#  <input type="submit" value="Envoyer participation" />#}
{#  <input type="reset" value="Reset" />#}
{#  </form>#}
</div>
{% endblock %}
{%  block js %}
{{  block.super }}
  <script type="text/javascript">
  $(function () {

      $('input[type="radio"][name="answer"]').on('change', function () {
          let $this = $(this),
              $dropButton = $this.parents('form').siblings('button')
          $dropButton.text($this.attr('js-displayed-answer'))
          $dropButton.click()

      })

      $('#reset_answers').on('click', function () {
          $('.answer_form').each(function (i,e) {
              let $form = $(e),
                  $button = $form.siblings('button')
              $form.trigger('reset')
              $button.text($button.attr('js-initial-data')) {# TODO: refactor. Attention à l'abus de données js- #}

          })

      })

      $('#submit_answers').on('click', function () {
          let data = $('input[name="csrfmiddlewaretoken"]').serializeArray()
          {#let answers = [],#}
          {#  token = $('input[name="csrfmiddlewaretoken"]').serializeArray()#}
          $('.answer_form').each(function (i, e) {
              let $form = $(e),
                  answer = $form.find('input[name="answer"]:checked').val()
                  //answer = $form.serializeArray()
              if (answer) {
                  data.push({name: 'participation', value: JSON.stringify({answer: answer, event: $form.find('input[name="event"]').val()}) })
              }

             /* if(Array.isArray(answer) && answer.length) {
                  data.push({name: 'participation', value: JSON.stringify({answer: answer[0].value, event: $form.attr('js-event-pk')}) })
              }*/
              {#$.each($(e).serializeArray(), function (i, e) {#}
              {#  console.log(e['name'] === 'answer')#}
              {#console.log($(e).serializeArray())#}
              {#console.log(typeof $(e).serializeArray())#}
          })
          {#token.push(answers)#}
          console.log(data)
          {#console.log($('.answer_form').serializeArray())#}
          {#console.log(typeof $('.answer_form').serializeArray())#}

          $.post('/participations/participate/', data)
      })

  })
  </script>
{% endblock %}