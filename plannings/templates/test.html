{%  extends 'core/base.html' %}
{%  block content %}
  <div class="container dropdown">
  <form id="planningForm" method="post" action="{% url 'plannings:edit' planning.ekey %}">
  {{ planning_form.as_p }}
  {% csrf_token %}
  {{ event_formset.management_form }}
  <div id="guests_container" {# style="display: none" #}>
    <div id="guest_emails_form">
      <div class="input-group">
        <input class="form-control" id="guest_email"  type="email" name="add_guest_email" placeholder="invité@exemple.com">
        <div class="input-group-append">
          <button id="guest_submit" class="btn btn-secondary">Ajouter cet email</button>
{#          <input id="guest_submit" class="btn btn-secondary" type="submit" value="Ajouter cet email">#}
        </div>
      </div>
    </div>
    <div id="GuestsContainer" class="bg-light my-3 rounded overflow-auto text-center" style="height: 100px">
      {% for email in planning.guest_emails.all %}
      <p id="{{ email }}">{{ email }}</p> {# TODO: changer id #}
      {% endfor %}
    </div>
    <div class="dropup">
      <button id="DeleteGuestDropdown" class="btn btn-danger mt-3 dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Supprimer des emails</button>
      <div id="guests_select_form" class="form-group text-center dropdown-menu" aria-labelledby="DeleteGuestDropdown">
        <div class="form-group">
        <label for="guests_email_select">Emails sélectionnés</label>
        <select id="guests_email_select" class="form-control mb-2" name="emails_to_delete" multiple>
          {% for email in planning.guest_emails.all %}
          <option value="{{ email }}">{{ email }}</option>
          {% endfor %}
        </select>
          <button id="delete_guest_submit" class="btn btn-danger">Supprimer ces emails</button>
{#          <input id="delete_guest_submit" class="btn btn-danger" type="submit" value="Supprimer">#}
        </div>
      </div>
    </div>
  </div>
{#  {% for form in event_formset.forms %}#}
{#    {{ form.as_p }}#}
{#  {% endfor %}#}
  <div id="newEventContainer">
  {% with form=event_formset.empty_form %}
    {% include 'plannings/event_form.html' with button_text='Ajouter un événement' hidde_delete=True %}
  </div>
  <div id="created_events_container" class="bg-dark row my-3 p-1 rounded">
  {% include 'plannings/event_card.html' with form_display=False %}
  {% endwith %}
  {% for form in event_formset.forms %}
    {% include 'plannings/event_card.html' with form_display=True button_text='Modifier' %}
  {% endfor %}
{#  <div>#}
{#  {{ event_formset.empty_form.as_p }}#}
{#  </div>#}
  </div>
  <input id="planning_submit" type="submit" value="submit">
{# TODO  <input id="resetPlanning" type="reset" value="reset">#}
  {% for email in planning.guest_emails.all %}
      <input type="hidden" value="{{ email }}" name="guest_email">
  {% endfor %}
  </form>
  <div class="alert alert-success" id="success-alert" style="display: none"> {# TODO: use bootstrap modal. on success, modal show set time out modal hide #}
    <button type="button" class="close" data-dismiss="alert">x</button>
    <strong>Success! </strong> Les informations sont valides.
  </div>
  <a class="btn btn-info" href="#">En haut</a>
</div>
{% endblock %}
{%  block js %}
  {{ block.super }}
  <script type="text/javascript">
  $(function () {
      $(".dropdown-toggle").dropdown({boundary: 'viewport'})

      $(".event_card_container:first").hide().attr("id", "modelEvent")

      function setEventCard($card) {
          let $form = $card.find('.event_form')
          $card.find(".card-header, .card-text").each(function (i, elem) {
              let $elem = $(elem),
                  inputID = "#id_"+$form.data("prefix")+"-"+$elem.data("field"), {# TODO: remplacer usage prefix par name fini par field, puisque dans bonne carte #}
                  $input = $form.find(inputID)
              {# TODO: if input is date: format with JS Date() #}
              $elem.text($input.val())

          })
          if ($form.find('#id_'+$form.data("prefix")+'-DELETE').prop("checked")) {
              $card.css("background-color", "#A0A0A0")
          } else {
              $card.css("background-color", "#ffa34d")
          }
      }

      $(".event_card").each(function () {
          setEventCard($(this))

      })

      /* TODO $("#planningForm").on("reset", function (event) {
          setTimeout(function () {
              $(".event_card").each(function () {
                  setEventCard($(this))

          }, 1)
              {# TODO: remove new cards #}

          })

      })*/

      /* TODO A voir si utile. Peut-etre setEventCard uniquement sur la carte qui vient de changer
      $("#planningForm").on("change", function () {
          $(".event_card").each(function () {
            setEventCard($(this))

          })
      })*/

      /*
      When the guest email input is submitted:
      -check if the guest's email is already added
      -add an option with the email as value to the guest's email select elem
      -add a hidden input with the guest's email as value
       */
      $("#guest_submit").on("click", function (event) {
          event.preventDefault()
          /*
          Get the data from the form. If the form has more input, a function to
           retrieve the exact input can be used: data.reduce(function(obj, item)
           { obj[item.name] = item.value; return obj;}, {} )['add_guest_email']
          */
          let $input = $('input[name="add_guest_email"]'),
              email = $input.val(),
              $guests_select = $("#guests_email_select"),
              $guests_container = $('#GuestsContainer')
          if ($guests_select.text().includes(email)) {
              alert("Vous avez déjà indiqué cette adresse")
          } else if (!$input[0].checkValidity()) {
              alert("Veuillez rentrez une adresse email valide")
          }
          else {
            $guests_container.append($("<p></p>", {id: email, text: email}))
            $guests_select.append($("<option></option>", {value: email, text: email}))
            $('#planningForm').append($("<input>", {value: email, type: "hidden", name: 'guest_email'}))
            $guests_container.scrollTop(
              $guests_container[0].scrollHeight)
          } $input.val("")
      });

      /*
      For each selected guest email option:
      -Remove the associate hidden input
      -Remove the option
       */
      $("#delete_guest_submit").on("click", function (event) {
          event.preventDefault()
          let data = $('#guests_email_select').serializeArray()
          console.log(data)
          $.each(data, function (i, field) {
            $('option[value="'+field.value+'"]').remove()
            $('p[id="'+field.value+'"]').remove()
            $('input[name="guest_email"][value="'+field.value+'"]').remove()
          })
      });

      function validExistingEvent($card) {
          setEventCard($card)
          $card.find('.dropdown-toggle').dropdown('hide')
          {# TODO: choisir append, prepend ou rien. $card.parent().appendTo($('#created_events_container'))#}
          $("#success-alert").fadeTo(2000, 500).slideUp(500, function() {
              $("#success-alert").slideUp(500);
          });

      }

      function validNewEvent($form, data) {
          /*let $formContainer = $form.parent(),
              emptyForm = $formContainer.children().clone(),
              $button = $formContainer.find('.dropdown-toggle'),
              $container = $('#modelEvent'),
              $card = $container.find('.card'),
              form_number = $('input[name$="TOTAL_FORMS"]').val()
          {#$button.text('Modifier')#}
          $formContainer.html($formContainer.html().replace(/__prefix__/g, form_number))
          $card.append($formContainer.find('.dropdown-toggle'), [$formContainer.find('.event_form')])
          {#$formContainer.append(emptyForm)#}
          $('.dropdown-toggle').dropdown('hide')
          $container.show()*/
          let $formContainer = $form.parent(),
              $container = $('#modelEvent').clone(),
              $card = $container.find('.card'),
              formset_prefix = $form.data('prefix').replace(/__prefix__/g, ""),
              $total_forms = $('input[name="'+formset_prefix+'TOTAL_FORMS"]'),
              form_number = $total_forms.val()

          $card.append($formContainer.html().replace(/__prefix__/g, form_number))
          {#console.log(document.getElementById("id_event_set-__prefix__-DELETE"))#}

          // Set the new event dropdown button
          let $dropdownButton = $card.find('.dropdown-toggle')
          $dropdownButton.text('Modifier')
          $dropdownButton.dropdown({boundary: 'viewport'})
          {#console.log(document.getElementById("id_event_set-__prefix__-DELETE"))#}


          // Set the data of the new event form and card
          $.each(data, function () {
              let $input = $card.find('[name$="'+this.name+'"]')
              if ($input.length && $input.attr('type') !== "hidden") {
                  $input.val(this.value)
              }

          })
          // Show the delete input and label
          $card.find('[name$="DELETE"]').parent().show()
          setEventCard($card)

          //Set the onClick function of validate event button
          $card.find('.validate_event').on('click', function (event) {
              event.preventDefault()
              validateEvent($(this).parents(".event_form"))

          })

          //Reset the 'add event' form
          $formContainer.find('input, textarea').each(function () {
              let $this = $(this),
                  type = $this.attr('type')
              if ($this.val() && type !== "hidden") {
                  if (type === 'checkbox') {
                      $this.prop('checked', false)
                  } else {
                      $this.val("")
                  }
              }

          })
          {#console.log(document.getElementById("id_event_set-__prefix__-DELETE"))#}

          // Increase the value of the TOTAL_FORMS input
          $total_forms.val(parseInt(form_number) + 1)

          $("#created_events_container").append($container)
          $container.removeAttr("id").show()
          $('.dropdown-toggle').dropdown('hide')
          /*let $newForm = $form.clone(),
              $newButton = $form.siblings('.dropdown-toggle').clone(),
              $container = $('#modelEvent'),
              $card = $container.find('.card'),
              form_number = $('input[name$="TOTAL_FORMS"]').val()
          console.log($newForm)
          console.log($newButton)
          $newButton.text('Modifier')
          $card.append($newButton, [$newForm])
          $card.html($card.html().replace(/__prefix__/g, form_number))
          $('.dropdown-toggle').dropdown('hide')
          $container.show()*/
          /*var form_idx = $('#id_form-TOTAL_FORMS').val();
        $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
        $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1)*/

          /*console.log('postfunc')
          console.log($card)
          setEventCard($card)
          $card.find('.dropdown-toggle').dropdown('hide')
          $("#success-alert").fadeTo(2000, 500).slideUp(500, function() {
              $("#success-alert").slideUp(500);
          });*/

      }

      function validateEvent($eventFormContainer) {
          {#console.log(document.getElementById("id_event_set-__prefix__-DELETE"))#}
          let data = $('input[name="csrfmiddlewaretoken"]').serializeArray(),
              prefix = $eventFormContainer.data("prefix")+"-";
          $eventFormContainer.find(".field_errors li").each(function (i, error) {
              error.remove()
          });



          $eventFormContainer.find('input, textarea').each(function () {
              if ($(this).val()) {
                  let value = $(this).serializeArray()[0]
                  if (value) {
                    value.name = value.name.replace(prefix,"")
                    data.push(value)
                  }
              }
          })

          {#console.log(data)#}
          $.post(location.origin+'/plannings/check_event/', data).done(function (response) {
              if (prefix.includes('__prefix__')) {
                  validNewEvent($eventFormContainer, data)
              } else {
                  validExistingEvent($eventFormContainer.parents('.card'))
              }

          }).fail(function (jqXHR) {
              if (jqXHR.status === 422) {
                  let data = JSON.parse(jqXHR.responseText)
                  $.each(data, function (field) {
                      let $errorsContainer = $("#id_" + prefix + field + "_errors"),
                          $input = $("#id_" + prefix + field)
                      $input.val(function () {
                          return this.defaultValue

                      })
                      $.each(data[field], function (i, error) {
                          $errorsContainer.append($('<li>' + error.message + '</li>'))

                      })
                  })
          } else {
              alert("Une erreur s'est produite, veuillez réessayer. Erreur HTTP "+jqXHR.status)
          }

          });
      }

      $('.validate_event').on('click', function (event) {
          event.preventDefault()
          validateEvent($(this).parents(".event_form"))

      })

      $('#validateNewEvent').on('click', function (event) {
          event.preventDefault()


          let $eventFormContainer = $(this).parents(".event_form"),
              data = $('input[name="csrfmiddlewaretoken"]').serializeArray(),
              $cardContainer = $("#model_event"),
              $card = $cardContainer.find('.card'),
              prefix = $eventFormContainer.data("prefix")+"-";
          $eventFormContainer.find(".field_errors li").each(function (i, error) {
              error.remove()
          });
          $eventFormContainer.find('input, textarea').each(function () {
              let value = $(this).serializeArray()[0]
              if (value) {
                  value.name = value.name.replace(prefix,"")
                  data.push(value)
              }

          })
          $.post(location.origin+'/plannings/check_event/', data).done(function (response) {
              let $newModel = $cardContainer.clone()
              $newModel.find(".dropdown-toggle").dropdown({boundary: 'viewport'})
              //$('#model_event').html($('#model_event').html().replace(/7/g,$('input[name*="TOTAL_FORMS"]').val()))


              $.each(data, function () {
                  let $input = $card.find('[name$="'+this.name+'"]')
                  if ($input.length && $input.attr('type') !== "hidden") {
                      $input.val(this.value)
                  }

              })
              setEventCard($card)
              $cardContainer.removeAttr("id").show()
              $('#created_events_container').append($newModel)
              {#setEventCard($card)#}
              {#$card.find('.dropdown-toggle').dropdown('hide')#}
              $("#success-alert").fadeTo(2000, 500).slideUp(500, function() {
                  $("#success-alert").slideUp(500);
              });

          })
          /*.fail(function (jqXHR) {
              if (jqXHR.status === 422) {
                  let data = JSON.parse(jqXHR.responseText)
                  $.each(data, function (field) {
                      let $errorsContainer = $("#id_" + prefix + field + "_errors"),
                          $input = $("#id_" + prefix + field)
                      $input.val(function () {
                          return this.defaultValue

                      })
                      $.each(data[field], function (i, error) {
                          $errorsContainer.append($('<li>' + error.message + '</li>'))

                      })
                  })
          } else {
              alert("Une erreur s'est produite, veuillez réessayer. Erreur HTTP "+jqXHR.status)
          }

          })*/

      })

      $('#guest_submit').on("click", function (event) {
          event.preventDefault()
          console.log($('#guest_email').val())

      })


  })
  </script>
{% endblock %}