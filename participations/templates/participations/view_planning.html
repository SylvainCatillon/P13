{%  extends 'core/base.html' %}
{%  block content %}
<div class="container table-responsive">
<h3 class="text-center">{{ planning.name }}</h3>
<br>
{% if user == planning.creator %}
  <a class="btn btn-block btn-dark" href="{% url 'plannings:edit' planning_ekey=planning.ekey %}">Modifier le planning</a>
  <br>
{% endif %}
{% csrf_token %}
<table class="table table-bordered text-center">
<thead class="thead-light">
<tr>
  <th class="text-muted">Événements</th>
  <th class="text-muted">Dispos</th>
  <th scope="col">{{ user.first_name }}</th>
  {% for participant in other_participants %}
    <th scope="col" class="d-none d-md-table-cell">{{ participant.first_name }}</th>
  {%  endfor %}
</tr>
</thead>
<tbody>
{%  for event in  events%}
  <tr>
    <td class="bg-dark"> {# events column #}
      <div class="dropright my-1">
        <a id="event_{{ event.id }}" class="dropdown-toggle btn text-white" data-toggle="dropdown" aria-expanded="false">
        {{ event.date|date:"d M" }}
        </a>
        <div class="dropdown-menu" aria-labelledby="event_{{ event.id }}">
          <p>{% if event.time %}{{ event.time }}{% endif %}</p>
          <p>{{ event.address }}</p>
          <p>{{ event.description }}</p>
        </div>
      </div>
    </td>
    <td> {# availabilities column #}
      <div class="dropright">
        <button id="summary_{{ event.id }}" class="dropdown-toggle btn" data-toggle="dropdown" aria-expanded="false">
          <span>{{ event.participations_summary.YES|length }} oui</span>
        </button>
        <div class="dropdown-menu" aria-labelledby="summary_{{ event.id }}">
          <ul class="list-group list-group-flush">
            <li class="list-group-item list-group-item-YES">
              <h5 >Oui</h5>
              {{ event.participations_summary.YES|join:", " }}
            </li>
            <li class="list-group-item list-group-item-MAYBE">
              <h5 >Peut-être</h5>
              {{ event.participations_summary.MAYBE|join:", " }}
            </li>
            <li class="list-group-item list-group-item-NO">
              <h5 >Non</h5>
              {{ event.participations_summary.NO|join:", " }}
            </li>
          </ul>
        </div>
      </div>
    </td>
    <td class="align-middle"> {# user column #}
      <div class="dropright my-1">
        {%  with participation=event.user_participation %}
        <button id="DropAnswerEvent{{ event.pk }}"
                class="dropdown-toggle btn btn-{{ participation.answer|default:"NONE" }}"
                data-toggle="dropdown"
                data-previous-answer="{{ participation.answer|default:"NONE" }}"
                aria-expanded="false">
        </button>
        <form class="dropdown-menu answer_form" aria-labelledby="DropAnswerEvent{{ event.pk }}" data-initial-text="{{ participation.get_answer_display }}">
          {% for answer, display in answer_choices %}
          <label  class="dropdown-item" for="Answer{{ answer }}Event{{ event.pk }}">
            <input type="radio" name="answer" value="{{ answer }}"
                   data-text="{{ display }}" id="Answer{{ answer }}Event{{ event.pk }}"
                {% if answer == participation.answer %} checked="checked" {% endif %}>
            <span>{{ display }}</span>
          </label>
          {% endfor %}
          <input type="hidden" name="event" value="{{ event.pk }}">
        </form>
      </div>
      {%  endwith %}
    </td>
      {% for participation in event.other_participations %} {# participants column #}
        <td class="d-none d-md-table-cell align-middle table-{{ participation.answer }}">
          <span>{{ participation.get_answer_display }}</span>
        </td>
      {% endfor %}
  </tr>
{% endfor %}
</tbody>
</table>
<button id="submit_answers" class="btn btn-info" data-post-url="{% url 'participations:participate' %}">Envoyer</button>
<button id="reset_answers" class="btn btn-info">Reset</button>
</div>
{% endblock %}
{%  block js %}
{{  block.super }}
  <script type="text/javascript">
  $(function () {

      /*
      Set the text and the color of the answer's dropdown button, with the
      values of the checked answer.
      */
      function setAnswerDropButton() {
          let $this = $(this),
              $button = $this.parents(".dropdown-menu").siblings('.dropdown-toggle')
          $button.text($this.data("text"))
          $button.removeClass("btn-"+$button.data("previous-answer"))
          $button.addClass("btn-"+$this.val())
          $button.data("previous-answer", $this.val())
          $button.dropdown('hide')
      }

      /*
      On page's load, set the answers' dropdown buttons if an answer is already
      checked.
      This is set by a script, because firefox keep cached the precedent form change
      after a page reload.
       */
      $('input[type="radio"][name="answer"]:checked').each(setAnswerDropButton)

      // Set the answer's dropdown button on every answer change
      $('input[type="radio"][name="answer"]').on("change", setAnswerDropButton)

      /*
      Reset all the answers' forms and their dropdown buttons on reset button click
       */
      $('#reset_answers').on('click', function () {
          $('.answer_form').each(function (i,e) {
              let $form = $(e),
                  $button = $form.siblings('.dropdown-toggle'),
                  $initialInput = $form.find("input[checked]"),
                  initial_text = "",
                  initial_value = "NONE"
              if ($initialInput.length) {
                  initial_text = $initialInput.data("text")
                  initial_value = $initialInput.val()
              }
              $form.trigger("reset")
              $button.removeClass("btn-"+$button.data("previous-answer"))
              $button.text(initial_text)
              $button.addClass("btn-"+initial_value)
              $button.data("previous-answer", initial_value)

          })

      })

      /*
      On submit button click, gather all the changed answers and put them in
      the 'data' array as a json string {answer: answer, event: event.pk}.
      Post the data to the submit url, and reload the page on success
       */
      $('#submit_answers').on('click', function () {
          let data = $('input[name="csrfmiddlewaretoken"]').serializeArray()
          $('.answer_form').each(function (i, e) {
              let $form = $(e),
                  answer = $form.find('input[name="answer"]:checked').val()
              if (answer && answer !== $form.data('initial-answer')) {
                  data.push({name: 'participation', value: JSON.stringify({answer: answer, event: $form.find('input[name="event"]').val()}) })
              }
          })
          $.post($(this).data('post-url'), data).done(function (msg) {
              alert(msg)
              location.reload()
          }).fail(function (jqXHR) {
              alert("Http code "+jqXHR.status+" "+jqXHR.responseText)
          })
      })

  })
  </script>
{% endblock %}